# 也许是一些冷门的知识总结

这里总结一些也许是冷门的知识点。

## 1. Java NPE无堆栈信息

**现象**：在分析日志时，抓到了NPE（NullPointerException）异常，但奇怪的是没有打印出异常的堆栈信息。

碰到这个现象就让人非常抓狂，NPE异常是非常好解决的。只要有堆栈信息，辅助定位后，就很容易解决。问题是没堆栈信息，只能猜哪一段代码存在问题，逐行排查是费时费力的。

先不说如何解决自己的业务问题，相信只要有堆栈信息，大家也都会解决此类问题。那么，为什么会出现这个现象呢？

**原理**：HotSpot VM有一个叫`fast throw`的优化：有些特定的隐式异常类型（NullPointerException）如果在代码中某个特定位置被抛出多次（JDK8，经观测5次）的话，HotSpot Server Compiler（C2）会透明的决定用fast throw来优化这个抛出异常的地方——直接抛出一个事先分配好的、类型匹配的异常对象。这个对象的message和stack trace都被清空。抛出这个异常的速度是非常快，不但不用额外分配内存，而且也不用爬栈；但反面就是可能正好是需要知道哪里出问题的时候看不到stack trace了。从Sun JDK5开始要避免C2做这个优化还得额外传个JVM参数：`-XX:-OmitStackTraceInFastThrow`。

**小技巧**：现在我们知道原理了，如果想看堆栈信息，那就添加上这个JVM参数即可。但是如果是在生产环境，那意味着需要多上线一次。那有什么办法解决呢？从原理看，我们知道必须是先多次抛出了，才会进行优化。如果我们看到的错误日志已经无堆栈信息了，那代表JVM在启动之后到现在已经抛出过多次。直接去找之前的错误日志，就可以找到相应的堆栈信息，然后解决。这样只需上线一次。如果之前的错误日志已经被自动删了，那么还是在测试环境尝试复现。否则的话，真没办法只能多上线一次了。

## 2. 服务端TIME_WAIT过多

**现象**：一次后端服务无响应，客户端调用返回超时，服务端程序日志中并未没有异常情况。